name: Staging Deploy to Amazon ECS

on:
  pull_request:
    branches:
      - develop
    types:
      - closed
#    paths:
#      - src/laravel/**
  workflow_dispatch:

env:
  aws_role_arn: AWS_ROLE_ARN
  ecs_cluster: ECS_CLUSTER
  ecs_service: ECS_SERVICE
  ecr_registry: ECR_REGISTRY # ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com
  ecr_repository: ECR_REPOSITORY
  task_family: TASK_FAMILY
  ecs_service_subnets: ECS_SERVICE_SECURITY_GROUP # ${{ vars.ECS_STAGING_SERVICE_SUBNETS }}
  ecs_service_security_group: ECS_SERVICE_SECURITY_GROUP #${{ vars.ECS_SERVICE_SECURITY_GROUP }}

jobs:
  lint:
    name: lint
    uses: ./.github/workflows/reusable-lint.yml
    if: github.event.pull_request.merged == true

  build:
    name: Build And ECR Push
    uses: ./.github/workflows/reusable-build.yml
    with:
      aws_role_arn: ${{ env.aws_role_arn }}
      ecr_registry: ${{ env.ecr_registry }}
      ecs_cluster: ${{ env.ecs_cluster }}
      supervisord_conf: supervisord_conf
      docker_file_path: docker_file_path
      task_definition: task_definition
      ecr_repository: ${{ env.ecr_repository }}
      ecs_service: ${{ env.ecs_service }}
    needs:
      - lint

  migration:
    needs: build
    uses: ./.github/workflows/reusable-migrate.yml
    with:
      aws-role-arn: aws-role-arn-from-staging-build
      aws-region: aws-region-from-staging-build
      ecs-cluster: ecs-cluster-from-staging-build
      task-family: task-family-from-staging-build
      ecs-service-subnets: ecs-service-subnets-from-staging-build
      ecs-service-security-group: ecs-service-security-group-from-staging-build
    secrets: inherit
